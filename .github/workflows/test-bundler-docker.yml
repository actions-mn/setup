name: test-bundler-docker

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: "${{ github.workflow }}-${{ github.head_ref || github.ref_name }}"
  cancel-in-progress: true

jobs:
  test-bundler-docker:
    name: Test use-bundler in ${{ matrix.name }} container
    runs-on: ubuntu-latest
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Metanorma"
            container: "metanorma/metanorma:latest"
            needs-setup: false
          - name: "Ruby"
            container: "ruby:3.3.7-slim-bookworm"
            needs-setup: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Create a minimal Gemfile for testing
      - name: Create test Gemfile
        run: |
          cat > Gemfile << 'EOF'
          source 'https://rubygems.org'
          gem 'metanorma-cli'
          EOF

      # Setup Ruby only for containers that need it
      - name: Setup Ruby
        if: matrix.needs-setup
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      # Test the enhanced use-bundler functionality
      - name: Test setup-metanorma with use-bundler
        uses: ./
        with:
          use-bundler: true

      # Verify the setup worked
      - name: Verify tools are functional
        run: |
          # Verify all tools are functional
          ruby --version
          bundle --version
          bundle exec metanorma version
          bundle exec fontist help
