name: test-bundler-native-os

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: "${{ github.workflow }}-${{ github.head_ref || github.ref_name }}"
  cancel-in-progress: true

jobs:
  test:
    name: Test use-bundler on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Create a minimal Gemfile for testing
      - name: Create test Gemfile
        shell: bash
        run: |
          cat > Gemfile << 'EOF'
          source 'https://rubygems.org'
          gem 'metanorma-cli'
          EOF

      # Setup Ruby manually (to test our auto-setup logic)
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      # Install Inkscape manually (to test our auto-setup logic)
      - name: Install Inkscape (cross-platform)
        uses: metanorma/ci/inkscape-setup-action@main

      # Test the enhanced use-bundler functionality
      - name: Test setup-metanorma with use-bundler
        uses: ./
        with:
          use-bundler: true

      # Verify the setup worked
      - name: Verify Metanorma installation
        shell: bash
        run: |
          # Check if metanorma command is available
          if command -v metanorma >/dev/null 2>&1; then
            echo "✅ Metanorma command found"
            bundle exec metanorma version
          else
            echo "❌ Metanorma command not found"
            exit 1
          fi

      - name: Verify Ruby environment
        shell: bash
        run: |
          # Check Ruby and bundler
          ruby --version
          bundle --version

          # Check if bundler can install gems
          bundle install --quiet

          # Try to run metanorma via bundler
          bundle exec metanorma version

      - name: Verify Inkscape installation
        shell: bash
        run: |
          # Check if inkscape is available
          if command -v inkscape >/dev/null 2>&1; then
            echo "✅ Inkscape found"
            inkscape --version
          else
            echo "❌ Inkscape not found"
            exit 1
          fi

      - name: Verify Fontist functionality
        shell: bash
        run: |
          # Test fontist via bundler
          bundle exec fontist help

      - name: Test document compilation (basic)
        shell: bash
        run: |
          # Create a minimal test document
          cat > test.adoc << 'EOF'
          = Test Document

          This is a test document to verify the setup works.

          == Section 1

          Basic text content.
          EOF

          # Try to compile it
          bundle exec metanorma test.adoc -t generic -x html

          # Check if output was generated
          if [ -f "test.html" ]; then
            echo "✅ Document compilation successful"
          else
            echo "❌ Document compilation failed"
            exit 1
          fi
