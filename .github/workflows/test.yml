name: test

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  lint:
    name: local tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - uses: actions/setup-node@v6
      with:
        node-version: '24.x'

    - run: yarn install
    - run: yarn build
    - run: yarn format-check
    - run: yarn test

  local-latest:
    name: local tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
    steps:
    - uses: actions/checkout@v6

    - uses: ./

    - run: env
      shell: bash

    - run: metanorma help

  # Fetch version data from metanorma/versions YAML files
  fetch-versions:
    name: Fetch Versions from YAML
    runs-on: ubuntu-latest
    outputs:
      snap-latest: ${{ steps.versions.outputs.snap-latest }}
      snap-test-version: ${{ steps.versions.outputs.snap-test-version }}
      chocolatey-latest: ${{ steps.versions.outputs.chocolatey-latest }}
      homebrew-latest: ${{ steps.versions.outputs.homebrew-latest }}
    steps:
    - uses: actions/checkout@v6

    - name: Fetch version data
      id: versions
      run: |
        # Fetch YAML files directly from metanorma/versions repository
        SNAP_YAML=$(curl -s https://raw.githubusercontent.com/metanorma/versions/main/data/snap/versions.yaml)
        HOMEBREW_YAML=$(curl -s https://raw.githubusercontent.com/metanorma/versions/main/data/homebrew/versions.yaml)
        CHOCOLATEY_YAML=$(curl -s https://raw.githubusercontent.com/metanorma/versions/main/data/chocolatey/versions.yaml)

        # Install yq for YAML parsing
        sudo snap install yq

        # Extract latest versions
        SNAP_LATEST=$(echo "$SNAP_YAML" | yq '.metadata.latest_version')
        CHOCO_LATEST=$(echo "$CHOCOLATEY_YAML" | yq '.metadata.latest_version')
        HOMEBREW_LATEST=$(echo "$HOMEBREW_YAML" | yq '.metadata.latest_version')

        # Get a test version from snap (use the first available version for testing)
        SNAP_TEST=$(echo "$SNAP_YAML" | yq '.versions[0].version')

        echo "snap-latest=$SNAP_LATEST" >> $GITHUB_OUTPUT
        echo "snap-test-version=$SNAP_TEST" >> $GITHUB_OUTPUT
        echo "chocolatey-latest=$CHOCO_LATEST" >> $GITHUB_OUTPUT
        echo "homebrew-latest=$HOMEBREW_LATEST" >> $GITHUB_OUTPUT

        echo "Snap latest: $SNAP_LATEST"
        echo "Snap test version: $SNAP_TEST"
        echo "Chocolatey latest: $CHOCO_LATEST"
        echo "Homebrew latest: $HOMEBREW_LATEST"

  # Native package manager tests - use versions from mnenv
  native-package-windows:
    name: Native Package Windows (Chocolatey)
    runs-on: windows-latest
    needs: fetch-versions
    steps:
    - uses: actions/checkout@v6

    - uses: ./
      with:
        version: ${{ needs.fetch-versions.outputs.chocolatey-latest }}

    - run: |
        metanorma --version
        echo "✓ Metanorma installed via Chocolatey (version ${{ needs.fetch-versions.outputs.chocolatey-latest }})"
      shell: bash

  native-package-macos:
    name: Native Package macOS (Homebrew)
    runs-on: macos-latest
    needs: fetch-versions
    steps:
    - uses: actions/checkout@v6

    - uses: ./
      with:
        version: ${{ needs.fetch-versions.outputs.homebrew-latest }}

    - run: |
        metanorma --version
        echo "✓ Metanorma installed via Homebrew (version ${{ needs.fetch-versions.outputs.homebrew-latest }})"

  native-package-ubuntu:
    name: Native Package Ubuntu (Snap)
    runs-on: ubuntu-latest
    needs: fetch-versions
    steps:
    - uses: actions/checkout@v6

    # Test Snap version-based installation using version data from YAML
    - uses: ./
      with:
        installation-method: 'native'
        version: ${{ needs.fetch-versions.outputs.snap-test-version }}

    - run: |
        metanorma --version
        echo "✓ Metanorma installed via Snap (version ${{ needs.fetch-versions.outputs.snap-test-version }})"

  # Gem-based installation tests
  docker-gem-ubuntu:
    name: Docker Gem Ubuntu
    runs-on: ubuntu-latest
    container:
      image: ubuntu:22.04
    steps:
    - uses: actions/checkout@v6

    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4'

    - uses: ./
      with:
        installation-method: 'gem'

    - run: bundle exec metanorma --version

  docker-gem-alpine:
    name: Docker Gem Alpine
    runs-on: ubuntu-latest
    container:
      image: ruby:alpine
    steps:
    - uses: actions/checkout@v6

    # ruby:alpine already includes Ruby and Bundler
    - uses: ./
      with:
        installation-method: 'gem'

    - run: bundle exec metanorma --version

  native-gem-ubuntu:
    name: Native Gem Ubuntu
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4'
        bundler-cache: true

    - uses: ./
      with:
        installation-method: 'gem'

    - run: bundle exec metanorma --version

  native-gem-macos:
    name: Native Gem macOS
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v6

    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4'
        bundler-cache: true

    - uses: ./
      with:
        installation-method: 'gem'

    - run: bundle exec metanorma --version

  # Gem version behavior tests
  gem-respects-gemfile-lock:
    name: Gem Respects Gemfile.lock
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4'

    # Create a Gemfile with specific version (1.13.0 doesn't have fontist LoadError issue)
    - run: |
        echo 'source "https://rubygems.org"' > Gemfile
        echo 'gem "metanorma-cli", "1.13.0"' >> Gemfile

    - uses: ./
      with:
        installation-method: 'gem'

    - run: |
        if bundle exec metanorma --version | grep -q "1.13.0"; then
          echo "correct metanorma version installed (respects Gemfile)"
        else
          echo "wrong metanorma version installed"
          bundle exec metanorma --version
          exit 1
        fi

  gem-specific-version:
    name: Gem Specific Version
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4'

    - uses: ./
      with:
        installation-method: 'gem'
        version: '1.13.0'

    - run: |
        if bundle exec metanorma --version | grep -q "1.13.0"; then
          echo "correct metanorma version installed"
        else
          echo "wrong metanorma version installed"
          bundle exec metanorma --version
          exit 1
        fi
